# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WAH4H Backend - Hardcoded Secrets Audit & Remediation Report
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Status: âš ï¸ FINDINGS IDENTIFIED - NOT YET PRODUCTION-READY

Audit Date: February 13, 2026
Auditor: Security Team
For: WAH4PC v1.0.0 Integration

---

## EXECUTIVE SUMMARY

**Overall Status:** âš ï¸ 3 CRITICAL HARDCODED VALUES FOUND

Action Required Before Production Deployment:
1. Replace hardcoded SECRET_KEY with environment variable
2. Replace hardcoded ALLOWED_HOSTS wildcard with specific domains
3. Replace hardcoded GATEWAY_URLs with environment variables
4. Parameterize DEBUG setting

Time to Fix: 15 minutes
Risk if Not Fixed: **HIGH** - Credentials exposed, security bypassed

---

## DETAILED FINDINGS

### ğŸ”´ CRITICAL: Hardcoded SECRET_KEY

**Location:** `wah4h-backend/wah4h/settings.py` (Line 14)

```python
# CURRENT (INSECURE):
SECRET_KEY = "django-insecure-rz74s8wlt7x+-10!5ky61@n4%7v*_o!$)fxe$e5@@8vh0kxo53"
```

**Risk Level:** ğŸ”´ **CRITICAL**

**Impact:**
- Session encryption compromised (attacker can forge sessions)
- CSRF token generation compromised
- Password reset tokens can be generated by attackers
- Affects ALL environments simultaneously

**Remediation:**

```python
# CORRECTED (SECURE):
import os
from dotenv import load_dotenv

load_dotenv()

SECRET_KEY = os.getenv('DJANGO_SECRET_KEY')
if not SECRET_KEY:
    raise ValueError("DJANGO_SECRET_KEY environment variable not set")
```

**Required Environment Variable:**
```bash
DJANGO_SECRET_KEY=<generate fresh key using command below>
```

**Generation:**
```bash
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

**Verification After Fix:**
```bash
python manage.py shell
>>> import os
>>> len(os.getenv('DJANGO_SECRET_KEY')) > 50
True  # Should print True
>>> exit()
```

---

### ğŸ”´ CRITICAL: Hardcoded ALLOWED_HOSTS Wildcard

**Location:** `wah4h-backend/wah4h/settings.py` (Line 16)

```python
# CURRENT (INSECURE):
ALLOWED_HOSTS = ["*"]
```

**Risk Level:** ğŸ”´ **CRITICAL**

**Impact:**
- **Host Header Injection attacks** - Attackers can manipulate host header to bypass security checks
- Password reset emails could point to attacker domains
- CSRF protection bypassed (host validation fails)
- Applies to all environments (development, staging, production)

**Remediation:**

```python
# CORRECTED (SECURE):
import os

# Parse comma-separated hosts from environment
ALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',')

# Ensure production doesn't use wildcard
if not DEBUG and '*' in ALLOWED_HOSTS:
    raise ValueError("ALLOWED_HOSTS cannot contain '*' when DEBUG=False")
```

**Required Environment Variables:**

```bash
# LOCAL:
ALLOWED_HOSTS=localhost,127.0.0.1

# STAGING:
ALLOWED_HOSTS=staging.wah4h.ph

# PRODUCTION:
ALLOWED_HOSTS=api.wah4h.ph,wah4h.ph
```

**Verification After Fix:**
```bash
python manage.py check
# Should pass without any errors
```

---

### ğŸ”´ CRITICAL: Hardcoded DEBUG=True

**Location:** `wah4h-backend/wah4h/settings.py` (Line 15)

```python
# CURRENT (INSECURE):
DEBUG = True
```

**Risk Level:** ğŸ”´ **CRITICAL** (if deployed to production)

**Impact if DEBUG=True in Production:**
- Full error stacktraces visible to attackers (reveals code structure)
- SQL queries exposed in errors (reveals database schema)
- Environment variables exposed in error page
- Filesystem paths revealed
- Static files always served (unnecessary overhead)
- Development tools enabled

**Remediation:**

```python
# CORRECTED (SECURE):
import os

DEBUG = os.getenv('DEBUG', 'False').lower() in ('true', '1', 'yes')
```

**Required Environment Variables:**

```bash
# LOCAL:
DEBUG=True

# STAGING:
DEBUG=False

# PRODUCTION:
DEBUG=False
```

**Verification After Fix:**
```bash
# Should show DEBUG=False in production
grep -n "^DEBUG=" manage.py  # Or check environment
```

---

### ğŸŸ¡ HIGH: Hardcoded GATEWAY_URL (Should Be Configurable)

**Location 1:** `wah4h-backend/patients/services/mapping_service.py` (Line 78)

```python
# CURRENT:
GATEWAY_URL = "https://wah4pc.echosphere.cfd"
```

**Location 2:** `wah4h-backend/patients/services/fhir_service.py` (Line 52)

```python
# CURRENT:
BASE_URL = "https://wah4pc.echosphere.cfd"
```

**Risk Level:** ğŸŸ¡ **HIGH**

**Impact:**
- Cannot easily switch between test/production gateway instances
- Requires code change to test with different gateway
- May need redeployment when gateway URL changes

**Remediation:**

Both files should read from environment variable:

```python
# CORRECTED (SECURE):
import os

GATEWAY_URL = os.getenv('WAH4PC_GATEWAY_URL', 'https://wah4pc.echosphere.cfd')
```

**Required Environment Variables:**

```bash
# LOCAL (if testing with real gateway):
WAH4PC_GATEWAY_URL=https://wah4pc.echosphere.cfd

# LOCAL (if using mock gateway):
WAH4PC_GATEWAY_URL=http://localhost:3000

# STAGING/PRODUCTION:
WAH4PC_GATEWAY_URL=https://wah4pc.echosphere.cfd
```

**Verification After Fix:**
```bash
python manage.py shell
>>> from patients.services.mapping_service import MappingService
>>> ms = MappingService()
>>> ms.GATEWAY_URL
'https://wah4pc.echosphere.cfd'  # Should read from env
>>> exit()
```

---

### ğŸŸ¡ HIGH: Hardcoded CORS_ALLOW_ALL_ORIGINS

**Location:** `wah4h-backend/wah4h/settings.py` (Line 120)

```python
# CURRENT (INSECURE):
CORS_ALLOW_ALL_ORIGINS = True
CORS_ALLOW_CREDENTIALS = True
```

**Risk Level:** ğŸŸ¡ **HIGH**

**Impact:**
- Any website can make requests to your API
- Combined with credentials, enables **CSRF attacks** (Cross-Site Request Forgery)
- Attackers can read patient data from malicious website
- Violates HIPAA/privacy requirements

**Remediation:**

```python
# CORRECTED (SECURE):
import os

# Disable global CORS, use whitelist instead
CORS_ALLOW_ALL_ORIGINS = False

# Only allow specific frontend origins
CORS_ALLOWED_ORIGINS = os.getenv('CORS_ALLOWED_ORIGINS', '').split(',') \
    if os.getenv('CORS_ALLOWED_ORIGINS') else []

# Verify production doesn't allow all origins
if not DEBUG and not CORS_ALLOWED_ORIGINS:
    raise ValueError("CORS_ALLOWED_ORIGINS must be configured in production")
```

**Required Environment Variables:**

```bash
# LOCAL:
CORS_ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000

# STAGING:
CORS_ALLOWED_ORIGINS=https://staging-app.wah4h.ph

# PRODUCTION:
CORS_ALLOWED_ORIGINS=https://app.wah4h.ph
```

**Verification After Fix:**
```bash
# Test that unauthorized origin is blocked
curl -i http://attacker.com/ \
  -H "Origin: http://attacker.com" \
  https://api.wah4h.ph/api/patients/
# Should NOT include "Access-Control-Allow-Origin" header
```

---

## SUMMARY TABLE: Hardcoded Values Found

| File | Line | Current Value | Risk | Fix | |
|------|------|---------------|------|-----|---|
| wah4h/settings.py | 14 | `SECRET_KEY = "django-insecure..."` | ğŸ”´ CRITICAL | Move to `os.getenv('DJANGO_SECRET_KEY')` | Pass |
| wah4h/settings.py | 15 | `DEBUG = True` | ğŸ”´ CRITICAL | Move to `os.getenv('DEBUG', 'False')` | Pass |
| wah4h/settings.py | 16 | `ALLOWED_HOSTS = ["*"]` | ğŸ”´ CRITICAL | Move to `os.getenv('ALLOWED_HOSTS')` | Pass |
| wah4h/settings.py | 120 | `CORS_ALLOW_ALL_ORIGINS = True` | ğŸŸ¡ HIGH | Configure whitelist via env var | Pass |
| patients/services/mapping_service.py | 78 | `GATEWAY_URL = "https://wah4pc.echosphere.cfd"` | ğŸŸ¡ HIGH | Move to `os.getenv('WAH4PC_GATEWAY_URL')` | Pass |
| patients/services/fhir_service.py | 52 | `BASE_URL = "https://wah4pc.echosphere.cfd"` | ğŸŸ¡ HIGH | Move to `os.getenv('WAH4PC_GATEWAY_URL')` | Pass |

**Total Issues: 6** (4 CRITICAL + 2 HIGH)

---

## REMEDIATION IMPLEMENTATION GUIDE

### Step 1: Update settings.py (wah4h/settings.py)

**Current:**
```python
from pathlib import Path
from datetime import timedelta
import os
from dotenv import load_dotenv

BASE_DIR = Path(__file__).resolve().parent.parent
load_dotenv(BASE_DIR / '.env')

# SECURITY
SECRET_KEY = "django-insecure-rz74s8wlt7x+-10!5ky61@n4%7v*_o!$)fxe$e5@@8vh0kxo53"
DEBUG = True
ALLOWED_HOSTS = ["*"]

# ... rest of settings
```

**Corrected:**
```python
from pathlib import Path
from datetime import timedelta
import os
from dotenv import load_dotenv

BASE_DIR = Path(__file__).resolve().parent.parent
load_dotenv(BASE_DIR / '.env')

# SECURITY
SECRET_KEY = os.getenv('DJANGO_SECRET_KEY')
if not SECRET_KEY:
    raise ValueError("ERROR: DJANGO_SECRET_KEY environment variable must be set")

DEBUG = os.getenv('DEBUG', 'False').lower() in ('true', '1', 'yes')

ALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',')
if not DEBUG and '*' in ALLOWED_HOSTS:
    raise ValueError("ERROR: ALLOWED_HOSTS cannot contain '*' when DEBUG=False")

# ... rest of settings

# Later in file:
CORS_ALLOW_ALL_ORIGINS = os.getenv('CORS_ALLOW_ALL_ORIGINS', 'False').lower() in ('true', '1')
if not DEBUG and CORS_ALLOW_ALL_ORIGINS:
    raise ValueError("ERROR: CORS_ALLOW_ALL_ORIGINS cannot be True in production")

CORS_ALLOWED_ORIGINS = os.getenv('CORS_ALLOWED_ORIGINS', '').split(',') \
    if os.getenv('CORS_ALLOWED_ORIGINS') else []
```

### Step 2: Update mapping_service.py

**Current:**
```python
class MappingService:
    GATEWAY_URL = "https://wah4pc.echosphere.cfd"
    PROVIDER_ID = os.getenv("WAH4PC_PROVIDER_ID", "")
```

**Corrected:**
```python
class MappingService:
    GATEWAY_URL = os.getenv("WAH4PC_GATEWAY_URL", "https://wah4pc.echosphere.cfd")
    PROVIDER_ID = os.getenv("WAH4PC_PROVIDER_ID", "")
```

### Step 3: Update fhir_service.py

**Current:**
```python
class FHIRService:
    BASE_URL = "https://wah4pc.echosphere.cfd"
```

**Corrected:**
```python
class FHIRService:
    BASE_URL = os.getenv("WAH4PC_GATEWAY_URL", "https://wah4pc.echosphere.cfd")
```

### Step 4: Verify Changes

```bash
# 1. Check Django configuration
python manage.py check
# Expected: "System check identified no issues (0 silenced)"

# 2. Verify environment variables are read
python manage.py shell
>>> import os
>>> from django.conf import settings
>>> print(f"DEBUG: {settings.DEBUG}")
>>> print(f"ALLOWED_HOSTS: {settings.ALLOWED_HOSTS}")
>>> print(f"SECRET_KEY length: {len(settings.SECRET_KEY)}")
>>> exit()

# 3. Test specific modules
python manage.py shell
>>> from patients.services.mapping_service import MappingService
>>> ms = MappingService()
>>> print(f"GATEWAY_URL: {ms.GATEWAY_URL}")
>>> exit()
```

---

## SECURITY VALIDATION CHECKLIST

After Implementing Fixes:

- [ ] SECRET_KEY is 50+ characters and unique per environment
- [ ] DEBUG=False in staging and production
- [ ] ALLOWED_HOSTS contains only specific domains (no `*`)
- [ ] CORS_ALLOW_ALL_ORIGINS=False (whitelist used instead)
- [ ] CORS_ALLOWED_ORIGINS contains only frontend domain
- [ ] WAH4PC_GATEWAY_URL is configurable via environment
- [ ] All hardcoded credentials removed from code
- [ ] `python manage.py check` passes without errors
- [ ] `.env` file is in `.gitignore` (secrets not committed)
- [ ] `.env.example` provides template without actual values

---

## DEPLOYMENT CHECKLIST

Before deploying to staging/production:

- [ ] All 6 hardcoded values remediated (see SUMMARY TABLE)
- [ ] Code changes tested in local environment
- [ ] `.env` file created with correct values for target environment
- [ ] `git check-ignore .env` confirms it's in `.gitignore`
- [ ] All validation tests pass (see Step 4 above)
- [ ] Team notified of security changes
- [ ] Rollback plan documented (if needed)

---

## SECURITY INCIDENT RESPONSE

### If This Code Was Deployed to Production (Before Fixes):

âš ï¸ **IMMEDIATE ACTIONS REQUIRED:**

1. **STOP:** Take affected environment offline
2. **ROTATE:** Change DJANGO_SECRET_KEY immediately
3. **RESET:** Force all users to re-authenticate (invalidate all sessions)
4. **REVIEW:** Audit logs for unauthorized access
5. **NOTIFY:** Inform security/compliance team
6. **PATCH:** Apply fixes from this document
7. **REDEPLOY:** With corrected environment variables

### Audit Trail Required:

- When was SECRET_KEY compromised?
- Which environments were affected?
- How many users logged in during exposed period?
- Any unauthorized patient data access in logs?

---

## COMPLIANCE NOTES

### HIPAA Requirements (US Healthcare):
- âœ… Credentials must not be hardcoded (this audit ensures compliance)
- âœ… Access controls require environment-specific keys (fixes enable this)
- âœ… Data in transit must use HTTPS (requires correct GATEWAY_URL configuration)

### Philippine Health Data Privacy (Local):
- âœ… Cryptographic keys must be environment-specific (prevents cross-environment compromise)
- âœ… Production credentials must be separate from development (this audit enforces it)

### OWASP Top 10 (Web Security):
- âœ… **A02:2021 - Cryptographic Failures:** Fixed hardcoded SECRET_KEY
- âœ… **A03:2021 - Injection:** Fixed HOST header injection via ALLOWED_HOSTS
- âœ… **A04:2021 - Insecure Design:** Fixed CORS misconfiguration

---

## FILES REQUIRING CHANGES

1. âœ“ `wah4h-backend/wah4h/settings.py` (6 lines changed)
   - Line 14: SECRET_KEY
   - Line 15: DEBUG
   - Line 16: ALLOWED_HOSTS
   - Line 120: CORS_ALLOW_ALL_ORIGINS
   - Line ~121: CORS_ALLOWED_ORIGINS (add if missing)

2. âœ“ `wah4h-backend/patients/services/mapping_service.py` (1 line changed)
   - Line 78: GATEWAY_URL

3. âœ“ `wah4h-backend/patients/services/fhir_service.py` (1 line changed)
   - Line 52: BASE_URL

Total: 3 files, 8 lines changed
Estimated Time: 15 minutes
Risk Level: Low (backward compatible, no database changes)

---

## REFERENCES

- **Django Security Documentation:** https://docs.djangoproject.com/en/stable/topics/security/
- **OWASP Secrets Management:** https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
- **12-Factor App Principles:** https://12factor.net/config
- **Python-dotenv Documentation:** https://github.com/theskumar/python-dotenv

---

## SIGN-OFF

- [ ] All hardcoded values identified
- [ ] Remediation guide reviewed
- [ ] Code changes implemented and tested
- [ ] Security validation checklist completed
- [ ] Ready for staging/production deployment

**Prepared By:** _________________________ **Date:** _____________

**Reviewed By:** _________________________ **Date:** _____________

**Approved By:** _________________________ **Date:** _____________

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
