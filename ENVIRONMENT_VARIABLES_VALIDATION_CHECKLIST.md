# ════════════════════════════════════════════════════════════════════════════════
# WAH4H Backend - Environment Variables Validation Checklist
# ════════════════════════════════════════════════════════════════════════════════
# Use this checklist before deploying to each environment

Last Updated: February 13, 2026
For WAH4PC v1.0.0 Integration

---

## DEPLOYMENT PRE-FLIGHT CHECKLIST

### Step 1: Django Core Security Variables

- [ ] **DJANGO_SECRET_KEY**
  - Format: 50+ character random string
  - ✓ Different from other environments
  - ✓ Not exposed in version control
  - ✓ Generated fresh (never reused)
  - Command to generate: `python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"`
  - Never use default value

- [ ] **DEBUG**
  - LOCAL: `True` only
  - STAGING: `False` ← MUST be False
  - PRODUCTION: `False` ← MUST be False
  - ⚠️ If DEBUG=True in production, sensitive error pages are visible to attackers
  - Verified: ☐

- [ ] **ALLOWED_HOSTS**
  - LOCAL: `localhost,127.0.0.1` (comma-separated, no spaces)
  - STAGING: `staging.wah4h.ph` (actual staging domain)
  - PRODUCTION: `api.wah4h.ph,wah4h.ph` (production domains, no wildcard)
  - ⚠️ Prevents Host Header Injection attacks
  - Does NOT include `*` in STAGING/PRODUCTION
  - Verified: ☐

### Step 2: Database Configuration

- [ ] **DATABASE_URL** OR **DB_* variables**
  - Choose ONE option:
    - Option A: `DATABASE_URL=postgresql://user:pass@host:5432/dbname`
    - Option B: Individual `DB_ENGINE`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`, `DB_HOST`, `DB_PORT`
  - LOCAL: SQLite (`sqlite:///db.sqlite3`) acceptable
  - STAGING: PostgreSQL recommended
  - PRODUCTION: PostgreSQL REQUIRED
  - Verified: ☐

- [ ] **Database Connection Details**
  - ✓ Database user is not `postgres` (use descriptive name like `wah4h_app`)
  - ✓ Database password is 20+ characters (generated, not a dictionary word)
  - ✓ Connection pooling configured (for production): pgBouncer or Pgpool-II
  - ✓ Database is accessible from application server
  - Test command: `python manage.py dbshell` (should connect without errors)
  - Verified: ☐

### Step 3: WAH4PC Gateway Integration

- [ ] **WAH4PC_GATEWAY_URL**
  - LOCAL: `http://localhost:3000` (or ngrok URL for local testing against real gateway)
  - STAGING/PRODUCTION: `https://wah4pc.echosphere.cfd`
  - ✓ Uses HTTPS in staging/production (never HTTP)
  - ✓ DNS resolves correctly: `nslookup wah4pc.echosphere.cfd`
  - Verified: ☐

- [ ] **WAH4PC_API_KEY**
  - Obtained from: WAH4PC Gateway Administrator
  - Format: `wah_` prefix followed by random string
  - ✓ Never commit to version control
  - ✓ Store in secure password manager (1Password, Vault, etc.)
  - ✓ Rotated annually minimum
  - Test: `curl -H "X-API-Key: {WAH4PC_API_KEY}" https://wah4pc.echosphere.cfd/api/providers/`
  - Verified: ☐

- [ ] **WAH4PC_PROVIDER_ID**
  - Obtained from: WAH4PC Gateway Administrator after provider registration
  - Format: UUID or custom alphanumeric ID (e.g., `wah-clinic-001`)
  - ✓ Matches registration records with gateway
  - ✓ Same value across all environments
  - Note: This is your unique identifier in the WAH4PC network
  - Verified: ☐

- [ ] **GATEWAY_AUTH_KEY**
  - Purpose: Authenticate INCOMING webhook requests from gateway
  - Generated by: YOU (using `python -c "import secrets; print(secrets.token_urlsafe(32))"`)
  - Shared with: WAH4PC Gateway Administrator (they use this to authenticate webhook calls)
  - ✓ 32+ characters (random alphanumeric)
  - ✓ Never commit to version control
  - ✓ Store securely
  - ✓ Communicated to gateway admin via secure channel (not email/Slack)
  - Validation: All webhook requests must include `X-Gateway-Auth: {GATEWAY_AUTH_KEY}` header
  - Verified: ☐

### Step 4: SSL/TLS Security Headers

#### LOCAL Development
- [ ] **SECURE_SSL_REDIRECT** = `False`
- [ ] **SESSION_COOKIE_SECURE** = `False`
- [ ] **CSRF_COOKIE_SECURE** = `False`
- [ ] **SECURE_HSTS_SECONDS** = `0`

#### STAGING Environment
- [ ] **SECURE_SSL_REDIRECT** = `True`
  - Redirect all HTTP to HTTPS
  - ⚠️ May break non-HTTPS clients
  - Verified: ☐

- [ ] **SESSION_COOKIE_SECURE** = `True`
  - Only send session cookie over HTTPS
  - Prevents session hijacking
  - Verified: ☐

- [ ] **CSRF_COOKIE_SECURE** = `True`
  - Only send CSRF token over HTTPS
  - Prevents CSRF token exposure
  - Verified: ☐

- [ ] **SECURE_HSTS_SECONDS** = `31536000` (1 year)
  - Enable HTTP Strict-Transport-Security header
  - Prevents protocol downgrade attacks
  - Verified: ☐

- [ ] **SECURE_HSTS_INCLUDE_SUBDOMAINS** = `True`
  - Include all subdomains in HSTS policy
  - Example: protects `staging-api.wah4h.ph`, `staging.wah4h.ph`
  - Verified: ☐

#### PRODUCTION Environment
- [ ] **SECURE_SSL_REDIRECT** = `True` ← REQUIRED
- [ ] **SESSION_COOKIE_SECURE** = `True` ← REQUIRED
- [ ] **CSRF_COOKIE_SECURE** = `True` ← REQUIRED
- [ ] **SECURE_HSTS_SECONDS** = `31536000` ← REQUIRED
- [ ] **SECURE_HSTS_INCLUDE_SUBDOMAINS** = `True` ← REQUIRED
- [ ] **SECURE_HSTS_PRELOAD** = `True` (optional but recommended)
  - Submit domain to HSTS preload list: https://hstspreload.org/
  - Verified: ☐

### Step 5: CORS & CSRF Configuration

- [ ] **CORS_ALLOWED_ORIGINS**
  - LOCAL: `http://localhost:5173,http://localhost:3000`
  - STAGING: `https://staging-app.wah4h.ph`
  - PRODUCTION: `https://app.wah4h.ph` (frontend domain ONLY)
  - ⚠️ NEVER use `*` in production (allows any domain)
  - ⚠️ NEVER include untrusted domains
  - Verified: ☐

- [ ] **CSRF_TRUSTED_ORIGINS**
  - Must match CORS_ALLOWED_ORIGINS
  - Prevents CSRF attacks from malicious websites
  - Also include localhost in LOCAL development
  - Format: comma-separated URLs with protocol (https://example.com)
  - Verified: ☐

### Step 6: Public URL Configuration (For Gateway Callbacks)

- [ ] **PUBLIC_BASE_URL**
  - LOCAL: `http://localhost:8000` (for local testing)
  - For local testing with real gateway: `https://your-ngrok-url.ngrok.io` (ngrok creates HTTPS tunnel)
  - STAGING: `https://staging-api.wah4h.ph` or `https://staging.wah4h.ph/api`
  - PRODUCTION: `https://api.wah4h.ph` or `https://wah4h.ph/api`
  - ⚠️ MUST be HTTPS in staging/production (gateway requirement)
  - ⚠️ Must be internet-accessible (gateway needs to reach your webhooks)
  - Test command (for production):
    ```bash
    curl -i https://api.wah4h.ph/fhir/receive-results
    # Should return "405 Method Not Allowed" or "401 Unauthorized" (not connection error)
    ```
  - Verified: ☐

### Step 7: Email Configuration (OTP & Notifications)

- [ ] **EMAIL_HOST**
  - Gmail: `smtp.gmail.com`
  - Organization SMTP: Provided by IT
  - Verified: ☐

- [ ] **EMAIL_PORT**
  - TLS (recommended): `587`
  - SSL: `465`
  - Check with your email provider
  - Verified: ☐

- [ ] **EMAIL_HOST_USER**
  - Format: Full email address (e.g., `noreply@wah4h.ph`)
  - For Gmail: Use app password credentials
  - Verified: ☐

- [ ] **EMAIL_HOST_PASSWORD**
  - ⚠️ CRITICAL: Use app password, NOT account password
  - For Gmail: Generate at https://myaccount.google.com/apppasswords
  - ✓ Never commit to version control
  - Test command (after deployment):
    ```bash
    python manage.py shell
    >>> from django.core.mail import send_mail
    >>> send_mail('Test', 'Test body', settings.DEFAULT_FROM_EMAIL, ['your-email@example.com'])
    >>> exit()
    ```
  - Verified: ☐

### Step 8: Logging Configuration

- [ ] **LOG_LEVEL**
  - LOCAL: `DEBUG` (verbose, for development)
  - STAGING: `INFO` (important events only)
  - PRODUCTION: `WARNING` or `ERROR` (only problems)
  - ⚠️ DEBUG level logs sensitive information (don't use in production)
  - Verified: ☐

### Step 9: Optional: Production Features

- [ ] **CACHE_BACKEND** (for multi-server deployments)
  - Development: Leave empty or use `locmem`
  - Production: Configure `redis` with connection pooling
  - Command to test: `python manage.py shell`
  - Verified: ☐

- [ ] **SENTRY_DSN** (for error tracking, optional but recommended)
  - Obtain from: https://sentry.io/
  - Captures unhandled exceptions in production
  - Verified: ☐

---

## VALIDATION TESTS

Run these commands after deployment to verify environment configuration:

### Test 1: Django Health Check (2 minutes)
```bash
python manage.py check
```
Expected output: "System check identified no issues (0 silenced)"

### Test 2: Database Connection (2 minutes)
```bash
python manage.py dbshell
```
Expected: Command prompt or SQL shell (not connection error)

### Test 3: Static Files (2 minutes)
```bash
python manage.py collectstatic --noinput --dry-run
```
Expected: Output shows static files, no errors

### Test 4: Secret Key Validation (1 minute)
```bash
python manage.py shell
>>> import os
>>> len(os.getenv('DJANGO_SECRET_KEY', '')) > 50
True  # Should print True
>>> exit()
```

### Test 5: WAH4PC Gateway Connectivity (2 minutes)
```bash
curl -i -H "X-API-Key: {YOUR_WAH4PC_API_KEY}" \
  -H "X-Provider-ID: {YOUR_WAH4PC_PROVIDER_ID}" \
  https://wah4pc.echosphere.cfd/api/providers/
```
Expected: HTTP 200 with provider list (not HTTP 401 Unauthorized)

### Test 6: Webhook Endpoint Accessibility (2 minutes)
```bash
# For public internet-accessible endpoint
curl -X POST https://api.wah4h.ph/fhir/receive-results \
  -H "Content-Type: application/json" \
  -H "X-Gateway-Auth: wrong-key" \
  -d '{"test": true}'
```
Expected: HTTP 401 Unauthorized (not connection timeout or 404)

### Test 7: SSL/TLS Certificate (2 minutes - PRODUCTION ONLY)
```bash
# Verify SSL certificate validity
openssl s_client -connect api.wah4h.ph:443 -servername api.wah4h.ph
```
Expected: "Verify return code: 0 (ok)" at end of output

### Test 8: Security Headers (2 minutes)
```bash
curl -I https://api.wah4h.ph/api/patients/
```
Expected headers in response:
- `Strict-Transport-Security` (PRODUCTION only)
- `X-Content-Type-Options`
- `X-Frame-Options`

### Full Integration Test (15 minutes)
Follow the BACKEND_LIFECYCLE_VALIDATION.md testing guide:
- TASK 2A: Test fetch request
- TASK 2B: Test webhook receipt
- TASK 2C: Test query flow

---

## CRITICAL SECURITY REMINDERS

### HIGH PRIORITY - Must Verify Before Deployment

1. ⚠️ **DEBUG must be False**
   - If DEBUG=True in production, error pages expose secret paths, database queries, environment variables
   - Verification: `grep DEBUG .env` should show `DEBUG=False` in production

2. ⚠️ **DJANGO_SECRET_KEY must be unique per environment**
   - If the same key is used across environments, compromising one compromises all
   - Verification: `python manage.py shell` and check if system accepts requests

3. ⚠️ **GATEWAY_AUTH_KEY must be strong**
   - Weak keys allow gateway accesses to webhook endpoints directly
   - Verification: Key must be 32+ random characters, not dictionary words
   - Impact: If compromised, attackers can inject patient data

4. ⚠️ **ALLOWED_HOSTS must NOT contain `*` in production**
   - If ALLOWED_HOSTS=["*"], Host Header Injection attacks are possible
   - Verification: `grep ALLOWED_HOSTS .env` should show specific domains only

5. ⚠️ **CORS_ALLOWED_ORIGINS must NOT contain untrusted domains**
   - If any domain can make requests, CSRF attacks are possible
   - Verification: Only include frontend domain in production

6. ⚠️ **HTTPS enforcement must be enabled in production**
   - If SECURE_SSL_REDIRECT=False, credentials can be intercepted
   - Verification: `curl http://api.wah4h.ph/` should redirect to `https://`

7. ⚠️ **WAH4PC_API_KEY must be rotated at least annually**
   - Long-lived credentials increase compromise risk
   - Track rotation date: _______________

8. ⚠️ **Email credentials must never be shared**
   - Use app passwords (Gmail) or service accounts (organization SMTP)
   - Verification: Test email delivery before going live

---

## ENVIRONMENT-SPECIFIC SUMMARY TABLE

| Variable | LOCAL | STAGING | PRODUCTION | Notes |
|----------|-------|---------|------------|-------|
| DJANGO_SECRET_KEY | Unique | Unique | Unique ← CRITICAL | Generate fresh for each |
| DEBUG | True | False | **False** ← CRITICAL | Never True in production |
| ALLOWED_HOSTS | localhost,127.0.0.1 | staging.wah4h.ph | api.wah4h.ph | No wildcards in prod |
| DATABASE_URL | sqlite3 | postgresql | postgresql | Use connection pooling |
| SECURE_SSL_REDIRECT | False | True | True | Force HTTPS in prod |
| SESSION_COOKIE_SECURE | False | True | True | Prevent session hijacking |
| CSRF_COOKIE_SECURE | False | True | True | Prevent CSRF in prod |
| SECURE_HSTS_SECONDS | 0 | 31536000 | 31536000 | 1 year HSTS policy |
| CORS_ALLOWED_ORIGINS | localhost:5173 | staging-app.wah4h.ph | app.wah4h.ph | Only frontend domain |
| PUBLIC_BASE_URL | http://localhost:8000 | https://staging-api | https://api.wah4h.ph | Must be HTTPS in prod |
| LOG_LEVEL | DEBUG | INFO | WARNING | Reduce verbosity in prod |
| WAH4PC_GATEWAY_URL | localhost:3000 | wah4pc.echosphere.cfd | wah4pc.echosphere.cfd | Same for staging/prod |

---

## DEPLOYMENT SIGN-OFF

- [ ] All environment variables set correctly
- [ ] All validation tests passed (8/8)
- [ ] Security reminders reviewed (8/8)
- [ ] Database backed up (if migrating)
- [ ] Secrets securely stored (password manager, vault, etc.)
- [ ] Team notified of deployment

**Deployed By:** _________________________ **Date:** _____________

**Approved By:** _________________________ **Date:** _____________

---

## SUPPORT & TROUBLESHOOTING

### If Django won't start:
```bash
python manage.py check  # Will show configuration errors
# Look for: SECRET_KEY, DEBUG, ALLOWED_HOSTS, DATABASE errors
```

### If webhooks aren't being called:
1. Verify `PUBLIC_BASE_URL` is internet-accessible: `curl https://PUBLIC_BASE_URL/fhir/receive-results`
2. Verify `GATEWAY_AUTH_KEY` matches what gateway admin has configured
3. Verify firewall/security groups allow traffic to webhook port

### If SSL certificate errors occur:
```bash
# Check certificate validity
openssl s_client -connect api.wah4h.ph:443
# Look for: "Verify return code: 0 (ok)"
```

### Emergency Troubleshooting Contact
- WAH4PC Gateway Support: [contact info]
- DevOps Team: [contact info]
- Security Team: [contact info]

════════════════════════════════════════════════════════════════════════════════
